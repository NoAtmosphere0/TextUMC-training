"""
The Synthesizer module is used to synthesize text based on the input, which is a cluster of semantically similar reports of a claim.

--------
Input: A cluster of semantically similar reports of a claim


Output: Synthesized text generated by the synthesizer module after passing the check of the hallucination checker model

--------

The base model is HuggingFaceTB/SmolLM2-1.7B

"""

"""
claim="Health care reform legislation is likely to mandate free sex change surgeries."
explain = "The release may have a point that Mikulski’s comment could open the door to \"medically necessary\" coverage which conceivably may include sex-change operations. But it's unclear whether her amendment will remain in the legislation, and there's nothing specific in the legislation on sex-change procedures and nothing else solid that indicates such coverage will be provided. The news release cherry-picked a few fleeting references to “gender” and “sexual orientation” in completely unrelated contexts to argue that proposed health care legislation would mandate free sex-change surgeries (and allow them for illegal aliens, no less).",
"""

# is_evidence in report number 3, 4, 9
"""
reports=
"content": "The Heritage Foundation COMMENTARY Gender A Court Victory in Texas Against Obamacare ’ s Transgender Mandate Aug 19th , 2021 3 min read A basic moral principle be at stake for health care provider .\n LWA / Dann Tardif / Getty Images Key Takeaways A federal district court judge block an Obama-era measure that force medical professional to participate in gender transition surgery and similar measure .\n A federal district court judge block an Obama-era measure that force medical professional to participate in gender transition surgery and similar measure , even against their medical or moral judgment .\n This “ transgender mandate ” saga begin in 2016 .\n Department of Health and Human Services manipulate the definition of “ sex ” to include sexual orientation and gender identity under Section 1557 of the Affordable Care Act , know a Obamacare .",
"content": "If you need urgent medical help , call triple zero immediately healthdirect Australia be a free service where you can talk to a nurse or doctor who can help you know what to do .\n What be gender confirmation surgery ? .\n Is the surgery right for me ? .\n What happen after the surgery ? .\n Being a transgender person mean you identify with a gender that be different from the sex you be assign at birth .\n Some have surgery as well .\n This article explain what to expect if you have gender confirmation surgery .\n Your sex refers to your physical or biological characteristic for example , whether you have a penis , vagina or breast , your hormone and your gene .",

"content": "This Chapter assume basic familiarity with term like “ transgender ” and “ cisgender ” and with the difference between assign sex at birth and gender identity .\n But information about , and access to , gender-affirming care for trans youth be more widespread than ever before .\n But the fight over gender-affirming healthcare for minor be far from over ; a of January 2021 , at least nine state be consider gender-affirming care bans,1111 .\n Section A will outline the current medical standard of care for trans youth and argue that access to gender-affirming care provide critical and empirically demonstrable psychological , social , and legal benefit for trans youth .\n The purpose of gender-affirming healthcare be usually to treat gender dysphoria ( “ dysphoria ” ) , or “ discomfort or distress that be cause by a discrepancy between a person ’ s gender identity and that person ’ s sex assign at birth .\n Importantly , dysphoria be a psychological condition that result from a difference between gender identity and assign sex at birth ; transgender identity be not itself a psychological condition or mental illness .\n Other medical association also provide guidance to clinician in specific area of care such a hormone treatment .\n Trans youth who have reach the early stage of puberty may be prescribe puberty blocker , which prevent the further progression of assigned-sex puberty and the development of associate secondary sex characteristic .\n and to prevent irreversible physical change that conflict with their desire gender presentation and increase dysphoria .\n trans youth can be prescribe hormone replacement therapy ( HRT ) , which cause development of secondary sex characteristic associate with the trans youth ’ s identify gender .\n 2018 ) ( observe that a Medicaid exclusion for gender-affirming healthcare be “ a straightforward case of sex discrimination ” because “ if plaintiff ’ natally assign sex have match their gender identity , their request , medically necessary surgery to reconstruct their genitalia or breast would be cover ” ) .",

"content": "The phase of the ‘ real life experience ’ include interpersonal transition from the biologically assign sex to the felt gender identity ; document transition , which include change of birth certificate , driver ’ s licence etc .\n ; and physical transition , which include hormone therapy and surgery .\n The ‘ real life experience ’ require the pre-operative individual to ‘ live ’ in their felt gender for a prolonged period of about one to two year , depend on the criterion establish by the gender identity clinic that be authorise the sex reassignment surgery .\n Many , but not all , gender identity clinic , include the Gender Identity Clinic at the Clarke Institute of Psychiatry , use ‘ real life experience ’ a a prerequisite to sex reassignment surgery .\n In consultation , one individual with a medical background state that the ‘ real life experience ’ do not provide useful information to the patient about what should be expect in sex reassignment surgery .\n Several people do acknowledge that it take time to make the decision to have sex reassignment surgery and what really should be provide to individual be a process of informed consent , a with any other type of surgery .\n [ 28 ] The cost of sex reassignment surgery vary .\n Indeed , the diagnosis facilitate their ability to identify in their felt gender and allow them to access sex reassignment surgery .",

"content": "Submit request document Appeal a Marketplace decision Confirm your Special Enrollment Period Pay premium & check coverage status Cancel a plan Health care & tax The penalty for not have coverage in 2018 & early Exemptions in 2018 & early Exemptions & Catastrophic plan Browse all topic > Why use the SHOP Marketplace ? .\n Verify your eligibility for SHOP Small Business Health Insurance Tax Credit How to work with an agent or broker Insurance for multiple location & business Minimum participation rate Appeal a SHOP Marketplace decision Additional resource for employer How to register with SHOP How to sell SHOP coverage Additional resource for agent & broker Exploring coverage option for business Learn more about individual coverage HRAs Learn more about QSEHRAs How to get cover if you 're a sole proprietor How the ACA affect small business Browse All Topics > Submit request document Appeal a Marketplace decision Confirm your Special Enrollment Period Pay premium & check coverage status Cancel a plan Taxes , fee , & exemption Health care & tax The penalty for not have coverage in 2018 & early Exemptions in 2018 & early Exemptions & Catastrophic plan Browse all topic > Apply for & enroll in 2022 coverage today Beat the Wednesday , December 15 , 2021 deadline to enroll in health coverage that start January 1 , 2022 .\n All Marketplace health plan and many other plan must cover the following list of preventive service without charge you a copayment or coinsurance .",
"content": "Ronni Sandroff be the former health editorial director for Consumer Reports , where she help find the CR Health Ratings Center and publish unique rating of health insurance , hospital , physician , treatment , and prescription drug .\n While the executive order protect transgender people from discrimination in routine medical care , it be not clear how it will affect gender reassignment treatment that be seek by many of the 1 .\n Key Takeaways Gender dysphoria be the high level of distress and discomfort that affect some people whose gender identity differs from the sex they be assign at birth or their sex-related physical trait .\n A diagnosis of gender dysphoria be require by health insurer before they will cover gender-altering treatment .\n Gender reassignment surgery be expensive .\n Bottom surgery can cost about $ 25,000 and top ( breast surgery ) from $ 7,800 to $ 10,000 .\n A medical diagnosis of gender dysphoria be require by health insurer before they will cover gender-altering treatment .",
"content": "Approved State Plan Amendments2021 Contact Apple Health ( Medicaid ) Behavioral health and recoveryWhat be work onBlock grant The Center of Parent Excellence ( COPE ) project Childrens Long-term Inpatient Program ( CLIP ) Mental health assessment for young child Ricky ’ s Law .\n ESB 5476 and behavioral health expansion Substance use disorder prevention and mental health promotion Washington State Hub and Spoke Project PartnersBehavioral Health Advisory Council Children and Youth Behavioral Health Work Group ( CYBHWG ) Meetings Members Events and train Resources Reports Crisis Response Improvement Strategy ( CRIS ) committee Family Youth System Partner Round Table ( FYSPRT ) Office of Recovery PartnershipsPeer respite Problem Gambling Task Force ( PGTF ) ReportsEvidence-based and research-based practice Mental health report Wraparound with Intensive Services ( WISe ) Cascade CareWhat be work on Clinical collaboration and initiativesWhat be work onBree Collaborative Eliminating hepatitis C Emerging Therapies Workgroup Opioid crisis Prescription drug price transparency How we work Partners Contact u Health Information TechnologyWhat be work onElectronic health record ( EHR ) a a service How we work NewsNewsletters ResourcesClinical Data Repository Promoting Interoperability Program ( PIP ) Washington State Medicaid HIT plan Contact u Health Technology AssessmentWhat be work onHealth technology review Topic selection Health Technology Clinical CommitteeClinical expert Committee member Recruitment How we workTechnology selection Key question Evidence report Coverage decision and meet Decision complete Tracking success How to participate Meetings and material Contact u Making inform health care decisionsPalliative care Hospice End\n mental health IMD PartnersAccountable Communities of Health ( ACHs ) Better Health Together Cascade Pacific Action Alliance Elevate Health Greater Columbia ACH HealthierHere North Central ACH North Sound ACH Olympic Community of Health SWACH Indian health care provider ( IHCPs ) Tracking successAnalytics , Research , and Measurement ( ARM ) ARM data dashboard Meetings & material Resources EventsLearning Symposium ( 2021 ) ReportsState Innovation Models ( SIM ) grant report Public Employees Benefits Board ( PEBB ) ProgramWhat be work on1095-C tax form How we work Operations How to participate Meetings & material Related law & rule Reports Contact u School Employees Benefits Board ( SEBB ) ProgramOperations Meetings and material NewsSEBB fact sheet Reports Trauma-informed approachHow to participate Tribal AffairsConsultations and meet Health care coverage Resources What be work onApple Health ( Medicaid ) quality strategy and compliance oversight Apple Health ( Medicaid ) MCO and BH-ASO state contract Governors Indian Health Advisory Council Indian Behavioral Health Act SB 6259 implementation Medicaid Transformation Nonemergency medical transportation ( NEMT ) contract Primary care case management ( PCCM ) contract Revised Indian Nation agreement and program agreement Contact u Uniform Medical Plan ( UMP ) What be work onCenters",
"content": "Excess hair , hair removal method , and barrier to care in GM patient .\n Standards of care for the health of transsexual , transgender , and gender-nonconforming people , version 7 .\n Guidelines for the primary and gender-affirming care of transgender and gender nonbinary people .\n Laser hair removal for genital gender affirm surgery .\n Overview of surgical technique in gender-affirming genital surgery .\n Nondiscrimination in health program and activity .\n HHS ’ s propose change to non-discrimination regulation under ACA section 1557 .\n Medicaid coverage for gender affirm care .\n Position statement on sexual and gender minority health in dermatology .",

"content": "The Department of Health and Human Services ( the Department or HHS ) be commit to ensure the civil right of all individual who access or seek to access health program or activity of covered entity under Section 1557 of the Patient Protection and Affordable Care Act ( ACA ) .\n This will better comply with the mandate of Congress , address legal concern , relieve billion of dollar in undue regulatory burden , far substantive compliance , reduce confusion , and clarify the scope of Section 1557 in keep with pre-existing civil right statute and regulation prohibit discrimination on the basis of race , color , national origin , sex , age , and disability .\n Through Section 1557 of the ACA , Congress apply certain long-standing civil right nondiscrimination requirement to any health program or activity that receive Federal financial assistance , and any program or activity administer by an Executive agency under Title I of the ACA or by an entity establish under such Title .\n It eliminate many of the provision of the 2016 Rule in order to good comply with the mandate of Congress , relieve approximately $ 2 .\n The 2016 Rule 's definition of discrimination on the basis of sex encompass discrimination on the basis of gender identity ( an individual 's internal sense of gender , which may be male , female , neither , or a combination of male and female ) .\n They purport to impose additional legal requirement on covered entity that can not be justify by the text of Title IX , and in fact be in conflict with express exemption in Title IX , even though Title IX provide the only statutory basis for Section 1557 's provision against discrimination on the basis of sex .\n The 2016 Rule 's provision on sex discrimination impose new requirement for care relate to gender identity and termination of pregnancy that Congress have never require , and prevent cover entity from draw reasonable and/or medically indicate distinction on the basis of sex .\n It eliminate the 2016 Rule 's definition of term and it list of example of discriminatory practice , as well a it provision relate to discrimination on the basis of association , disparate impact on the basis of sex , health insurance coverage , certain employee health benefit program , notification of beneficiary ' right under civil right law , designation of responsible employee and adoption of grievance procedure , access grant to OCR for review of covered entity ' record of compliance , prohibition on intimidation and retaliation , enforcement procedure , private right of action , remedial action , and voluntary action .\n In all of these matter , this final rule will defer to the relevant exist regulation and the relevant case law with respect to each of the underlie civil right statute , a apply to the health context under Section 1557 .\n Specifically , it eliminate the burdensome requirement for covered entity to send notice and taglines with all significant communication , clarifies that the provision of health insurance , a such , be not a health program or activity , bring requirement of meaningful access for person with limited English proficiency ( LEP ) into conformity with longstanding DOJ and HHS guidance , and permit remote English-language interpreting service to be audio-based rather than require them to be video-based .",

"content": "The Texas Tribune Texas lawmaker advance bill block access to gender-affirming health care despite opposition from LGBTQ Texans , medical association Equality Texas CEO Ricardo Martinez say Texas have file more anti-LGBTQ bill this session than any other state legislature .\n Several speaker oppose a slate of bill at the Texas Legislature that target transgender Texans access to health care and school sport .\n For LGBTQ mental health support , call the Trevor Project ’ s 24/7 toll-free support line at 866-488-7386 .\n Read our mental health resource guide for more information .\n Before undergoing gender confirmation surgery at age 17 , Indigo Giles have to get approval from a doctor , a therapist and the hospital where the surgery would be perform to ensure there be no option leave besides surgery .",
"content": "© 2019 Human Rights Watch Summary The procedure in Japan for change an individual ’ s legal gender be regressive and harmful .\n It rest on an outdated and pejorative notion that a transgender identity be a mental health condition , and require transgender people who want legal recognition to undergo lengthy , expensive , invasive , and irreversible medical procedure .\n “ Transgender ” be an inclusive term for anyone whose sex assign to them at birth do not conform to their live or perceive gender .\n The existence of a law in Japan allow transgender people to change their legal gender signal the government ’ s willingness to engage with and support transgender people .\n And legal gender recognition be an essential element of other fundamental rights—including the right to privacy , the right to freedom of expression , right relate to employment , education , health , and the ability to move freely .\n The Japanese government should urgently reexamine it law and revise it accord to it international human right obligation and medical best practice to allow transgender people a transparent and quick administrative procedure to change their legal gender .\n The independent expert call for the elimination of abusive requirement a prerequisite for change of legal sex or gender , include .\n Forced , coerce or otherwise involuntary sterilization ; Medical procedure relate to transition , include surgery and hormonal therapy ; Undergoing medical diagnosis , psychological appraisal or other medical or psychosocial procedure or treatment ; Requirements relate to economic status , health , marital , family or parental status ; and Any third-party opinion .\n To the Ministry of Justice Revise Law 111 of 2003 , the GID Special Cases Act , to bring it into accordance with international human right standard and medical best practice so that individual ’ gender marker in the family registry can be change without have to satisfy any medical condition .\n In particular , abolish the current condition of sex reassignment surgery and irreversible infertility , as well a the requirement that applicant have no underage child .",
"content": "Protecting and Advancing Health Care for Transgender Adult Communities The federal government and policymakers must address health disparity and barrier to care for transgender community by implement holistic policy solution .\n Advancing Racial Equity and Justice , Strengthening Public Health and Ending the Pandemic , Health Care , LGBTQ Communities of Color , LGBTQ Health , LGBTQ Rights A man guide his stepdaughter in a wheelchair through a parking lot outside a wound care clinic in Los Angeles , 2021 .\n “ Transgender ” be an umbrella term use to describe people whose gender identity and/or gender expression differ base on the sex they be assign at birth .\n Discrimination , stigma , and violence , along with other social , political , and economic factor , significantly affect the physical , mental , and behavioral health of transgender adult .\n 2 Research demonstrate that , compare with the general population , transgender people suffer from more chronic health condition and experience high rate of health problem relate to HIV/AIDS , substance use , mental illness , and sexual and physical violence , as well a high prevalence and early onset of disability that can also lead to health issue .\n 3 In addition to poor health outcome , transgender people also encounter unique challenge and inequality in their ability to access health insurance and adequate care .\n 4 The public health and economic crisis spur by the COVID-19 pandemic have only exacerbate exist disparity and barrier to care for transgender people , especially transgender people of color .\n Adopting both nondiscrimination law and inclusive policy will be critical for improve health outcome and the daily life of the estimate 1 .\n To examine the health condition that transgender adult face , this report incorporate storytelling to elevate their lived experience .\n The status of the physical , behavioral , and mental health of transgender community and barrier to access general and gender-affirming care The contemporary landscape of legal and regulatory nondiscrimination protection in health care In-practice policy to promote affirming , inclusive , and culturally competent care Transgender individual be a high-risk population for mental and physical health problem and be consistently and systemically underserved by the American medical system .",
"content": "I ’ m fine with cooky Coronavirus - be furlough if you can ’ t work Coronavirus - if you have problem get your furlough pay Coronavirus - if youre self-employed Coronavirus - if youre worry about work Coronavirus - if you need to be off work to care for someone Rights at work Leaving a job Problems at work View all in Work NHS and adult social care complaint Find out how to complain about your doctor or health visitor .\n Checking standard of healthcare service The Care Quality Commission The Care Quality Commission check all hospital and provider of primary health service ( for example , GPs and dentist ) to see if they be meet government standard .\n You can find out about what to expect from your health service provider on the Care Quality Commission .\n You can also give feedback about the standard of care you receive , but the Care Quality Commission can not deal with individual complaint .\n MyNHS You can also compare the performance and customer rating of your local health service on the MyNHS website .\n The site be intend to help you choose where to go for your health service .\n food quality staff patient safety mental health Right to a GP You have the right to register with a GP if you live within the GP 's catchment area even if you come from abroad .\n surgery address and telephone number gender of the GP languages speak by the GP , if the GP agree this should be include particular health interest , if the GP agree this should be include whether the GP do minor surgery whether the GP offer contraceptive and/or maternity service what the GP ’ s deputise arrangement be and whether a commercial deputising service be use The list may also contain information on whether any alternative therapy be available within the practice .\n It may also give detail of surgery hour , whether there be an appointment system and whether there be any special clinic run at the surgery .",
"content": "The following insurance carrier have available plan without blanket exclusion for transgender surgery and other trans-related healthcare .\n secure health insurance coverage through one of the following channel .\n Additionally , some state and federal public employee be cover for transition-related care through their group benefit plan .\n Medicare provide health insurance to million of old and disabled Americans .",
"content": "Final LCDs by Contractor Report Final LCDs by State Report Final LCDs Alphabetical Report Proposed LCDs by Contractor Report Proposed LCDs by State Report Proposed LCDs Alphabetical Report Currently , the local Medicare Administrative Contractors ( MACs ) determine coverage of gender reassignment surgery on an individual claim basis .\n The Centers for Medicare & Medicaid Services ( CMS ) propose to continue this practice and not issue a National Coverage Determination ( NCD ) at this time on gender reassignment surgery for Medicare beneficiary with gender dysphoria .\n Our review of the clinical evidence for gender reassignment surgery be inconclusive for the Medicare population at large .\n The low number of clinical study specifically about Medicare beneficiary ’ health outcome for gender reassignment surgery and small sample size inhibit our ability to create clinical appropriateness criterion for cohort of Medicare beneficiary .\n Based on the gap identify in the clinical evidence , these study should focus on which patient be most likely to achieve improve health outcome with gender reassignment surgery , which type of surgery be most appropriate , and what type of physician criterion and care setting ( s ) be need to ensure that patient achieve improve health outcome .\n We be specifically interested in public comment on the evidence we cite in this decision , comment contain any new evidence that have not be consider , and comment on whether a study could be develop that would support coverage with evidence development ( CED ) , which would only cover gender reassignment surgery for beneficiary who choose to participate in a clinical study .\n Proposed Decision Currently , the local Medicare Administrative Contractors ( MACs ) determine coverage of gender reassignment surgery on an individual claim basis .\n The Centers for Medicare & Medicaid Services ( CMS ) propose to continue this practice and not issue a National Coverage Determination ( NCD ) at this time on gender reassignment surgery for Medicare beneficiary with gender dysphoria .\n Our review of the clinical evidence for gender reassignment surgery be inconclusive for the Medicare population at large .\n The low number of clinical study specifically about Medicare beneficiary ’ health outcome for gender reassignment surgery and small sample size inhibit our ability to create clinical appropriateness criterion for cohort of Medicare beneficiary .\n Based on the gap identify in the clinical evidence , these study should focus on which patient be most likely to achieve improve health outcome with gender reassignment surgery , which type of surgery be most appropriate , and what type of physician criterion and care setting ( s ) be need to ensure that patient achieve improve health outcome .",
"content": "Approved State Plan Amendments2021 Contact Apple Health ( Medicaid ) Behavioral health and recoveryWhat be work onBlock grant The Center of Parent Excellence ( COPE ) project Childrens Long-term Inpatient Program ( CLIP ) Mental health assessment for young child Ricky ’ s Law .\n ESB 5476 and behavioral health expansion Substance use disorder prevention and mental health promotion Washington State Hub and Spoke Project PartnersBehavioral Health Advisory Council Children and Youth Behavioral Health Work Group ( CYBHWG ) Meetings Members Events and train Resources Reports Crisis Response Improvement Strategy ( CRIS ) committee Family Youth System Partner Round Table ( FYSPRT ) Office of Recovery PartnershipsPeer respite Problem Gambling Task Force ( PGTF ) ReportsEvidence-based and research-based practice Mental health report Wraparound with Intensive Services ( WISe ) Cascade CareWhat be work on Clinical collaboration and initiativesWhat be work onBree Collaborative Eliminating hepatitis C Emerging Therapies Workgroup Opioid crisis Prescription drug price transparency How we work Partners Contact u Health Information TechnologyWhat be work onElectronic health record ( EHR ) a a service How we work NewsNewsletters ResourcesClinical Data Repository Promoting Interoperability Program ( PIP ) Washington State Medicaid HIT plan Contact u Health Technology AssessmentWhat be work onHealth technology review Topic selection Health Technology Clinical CommitteeClinical expert Committee member Recruitment How we workTechnology selection Key question Evidence report Coverage decision and meet Decision complete Tracking success How to participate Meetings and material Contact u Making inform health care decisionsPalliative care Hospice End\n mental health IMD PartnersAccountable Communities of Health ( ACHs ) Better Health Together Cascade Pacific Action Alliance Elevate Health Greater Columbia ACH HealthierHere North Central ACH North Sound ACH Olympic Community of Health SWACH Indian health care provider ( IHCPs ) Tracking successAnalytics , Research , and Measurement ( ARM ) ARM data dashboard Meetings & material Resources EventsLearning Symposium ( 2021 ) ReportsState Innovation Models ( SIM ) grant report Public Employees Benefits Board ( PEBB ) ProgramWhat be work on1095-C tax form How we work Operations How to participate Meetings & material Related law & rule Reports Contact u School Employees Benefits Board ( SEBB ) ProgramOperations Meetings and material NewsSEBB fact sheet Reports Trauma-informed approachHow to participate Tribal AffairsConsultations and meet Health care coverage Resources What be work onApple Health ( Medicaid ) quality strategy and compliance oversight Apple Health ( Medicaid ) MCO and BH-ASO state contract Governors Indian Health Advisory Council Indian Behavioral Health Act SB 6259 implementation Medicaid Transformation Nonemergency medical transportation ( NEMT ) contract Primary care case management ( PCCM ) contract Revised Indian Nation agreement and program agreement Contact u Uniform Medical Plan ( UMP ) What be work onCenters",
"""

is_evidence = """
"sent": "2018 ) ( observe that a Medicaid exclusion for gender-affirming healthcare be “ a straightforward case of sex discrimination ” because “ if plaintiff ’ natally assign sex have match their gender identity , their request , medically necessary surgery to reconstruct their genitalia or breast would be cover ” ) .",
"is_evidence": 1
"sent": "Indeed , the diagnosis facilitate their ability to identify in their felt gender and allow them to access sex reassignment surgery .",
"is_evidence": 1
"sent": "The 2016 Rule 's provision on sex discrimination impose new requirement for care relate to gender identity and termination of pregnancy that Congress have never require , and prevent cover entity from draw reasonable and/or medically indicate distinction on the basis of sex .",
"is_evidence": 1
"""

SYSTEM_PROMPT = f"""
You are an AI assistant designed to assist with fake news detection. Your task is to synthesize information by selecting the most relevant sentences from a set of semantically similar reports provided by the user. The goal is to highlight the sentences that are most aligned with the original claim while preserving factual accuracy and ensuring conciseness.

Instructions:
Input: You will be provided with:
- An original claim (the focus of the analysis).
- A list of reports (text documents containing related information).

Output: Your response must consist of:
- The selected sentences from the provided reports that are most relevant to the original claim.
- The sentences must be directly taken from the reports; do not generate new content or alter the sentences.

Selection Criteria:
- Relevance: Choose sentences that address the key points or details of the claim.
- Clarity: Prioritize clear, unambiguous statements.
- Supportiveness: Include sentences that directly confirm, refute, or provide additional context to the claim.

"""

import torch
from transformers import AutoModelForCausalLM, AutoTokenizer
from source.hallucination_checker import HallucinationChecker

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")


class Synthesizer:
    """
    The Synthesizer module is used to synthesize text based on the input, which is a cluster of semantically similar reports of a claim.

    -----
    Input: A cluster of semantically similar reports of a claim

    Output: Synthesized text generated by the synthesizer module after passing the check of the hallucination checker model

    -----

    """

    def __init__(self, model_path: str = None, tokenizer_path: str = None):
        """Initializes the Synthesizer class with the model and tokenizer

        The base model is HuggingFaceTB/SmolLM2-1.7B

        """
        if model_path and tokenizer_path:
            self.model = AutoModelForCausalLM.from_pretrained(
                model_path, trust_remote_code=True
            )
            self.tokenizer = AutoTokenizer.from_pretrained(
                tokenizer_path, trust_remote_code=True
            )
        else:
            self.model = AutoModelForCausalLM.from_pretrained(
                "../models/SmolLM2-1.7B-Instruct"
            ).to(device)
            self.tokenizer = AutoTokenizer.from_pretrained(
                "../models/SmolLM2-1.7B-Instruct"
            )

        self.hallucination_checker = HallucinationChecker()

    def synthesize(self, claim: str, reports: list) -> str:
        """Synthesizes text based on the input reports

        Args:
            reports (list): A list of semantically similar reports of a claim

        Returns:
            str: The synthesized text generated by the synthesizer module after passing the check of the hallucination checker model
        """
        reference = " ".join(reports)
        reports = "\n".join(reports)
        messages = [
            {
                "role": "system",
                "content": SYSTEM_PROMPT,
            },
            {
                "role": "user",
                "content": f"Here is the {claim} and the reports: {reports}",
            },
        ]

        input_text = self.tokenizer.apply_chat_template(messages, tokenize=False)
        inputs = self.tokenizer.encode(input_text, return_tensors="pt").to(device)
        outputs = self.model.generate(
            inputs, max_new_tokens=50, temperature=0.2, top_p=0.9, do_sample=True
        )  # TODO: add parameters to reduce hallucination and bad output

        # get assistant response
        output_txt = self.tokenizer.decode(outputs[0], skip_special_tokens=True)

        # Get text between "<|im_start|>assistant\n" and "<|im_end|>"
        # if "<|im_start|>assistant\n" in output_txt:

        response = output_txt.split("assistant\n")[
            1
        ]  #! Might not be best practice, need to read more about this

        if self.hallucination_checker.check_hallucination(
            reference, input_text, response
        ):
            print("Passes hallucination check. Synthesis successful.")
            print("Synthesized text:", response)
            return response
        else:
            print("Hallucination detected. Retrying synthesis.")
            return self.synthesize(
                claim=claim, reports=reports
            )  # TODO: Should not use recursion here, change to while loop instead


# TODO: Try to download the models again and add/change paths into local paths in the files.
# TODO: refine the flow of the code
